!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("three/build/three.module")):"function"==typeof define&&define.amd?define(["exports","three/build/three.module"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).THREE_GPU_ParticleSystem={},t.three_module)}(this,(function(t,e){"use strict";var r=[[-.5,-.5],[.5,-.5],[.5,.5],[-.5,.5]];function i(t){return function(){var e=t.now_,r=t.timeBase_;return(e.getTime()-r.getTime())/1e3}}var a=12,n=16,o=20,l=24,s=28,c=new Float32Array(112);function u(){this.numParticles=1,this.numFrames=1,this.frameDuration=1,this.frameStart=0,this.frameStartRange=0,this.timeRange=99999999,this.startTime=null,this.lifeTime=1,this.lifeTimeRange=0,this.startSize=1,this.startSizeRange=0,this.endSize=1,this.endSizeRange=0,this.position=[0,0,0],this.positionRange=[0,0,0],this.velocity=[0,0,0],this.velocityRange=[0,0,0],this.acceleration=[0,0,0],this.accelerationRange=[0,0,0],this.spinStart=0,this.spinStartRange=0,this.spinSpeed=0,this.spinSpeedRange=0,this.colorMult=[1,1,1,1],this.colorMultRange=[0,0,0,0],this.worldVelocity=[0,0,0],this.worldAcceleration=[0,0,0],this.billboard=!0,this.orientation=[0,0,0,1]}class m extends e.Mesh{constructor(t,e){super(),this.emitter_=t.clone(),this.scene=e,this.world_=new THREE.Matrix4,this.tempWorld_=new THREE.Matrix4,this.timeOffset_=0,this.visible_=!1;var r=t.particleSystem,i=r.drawables_.indexOf(this.emitter_);i>=0&&r.drawables_.splice(i,1),r.drawables_.push(this)}trigger(t){this.visible_||this.scene.add(this.emitter_),t&&this.emitter_.position.copy((new THREE.Vector3).fromArray(t)),this.visible_=!0,this.timeOffset_=this.emitter_.timeSource_()}draw(t,e,r){this.visible_&&this.emitter_.draw(this.world_,e,this.timeOffset_)}}class f extends e.Mesh{constructor(t,e,r){super(),r=r||t.timeSource_,this.particleBuffer_=new THREE.InstancedBufferGeometry,this.interleavedBuffer=new THREE.InterleavedBuffer,this.numParticles_=0,this.rampTexture_=t.defaultRampTexture,this.colorTexture_=e||t.defaultColorTexture,this.particleSystem=t,this.timeSource_=r,this.setState(THREE.NormalBlending)}setTranslation(t,e,r){this.position.x=t,this.position.y=e,this.position.z=r}setState(t){this.blendFunc_=t}setColorRamp(t){var e=t.length/4;if(e%1!=0)throw"colorRamp must have multiple of 4 entries";this.rampTexture_==this.particleSystem.defaultRampTexture&&(this.rampTexture_=null),this.rampTexture_=this.particleSystem.createTextureFromFloats(e,1,t,this.rampTexture_)}validateParameters(t){var e=new u;for(var r in t)if(void 0===e[r])throw'unknown particle parameter "'+r+'"';for(var r in e)void 0===t[r]&&(t[r]=e[r])}createParticles_(t,e,i,c){var u=this.interleavedBuffer.array;this.billboard_=i.billboard;for(var m=this.particleSystem.randomFunction_,f=function(t){return(m()-.5)*t*2},d=function(t){for(var e=[],r=0;r<t.length;++r)e.push(f(t[r]));return e},h=0;h<e;++h){c&&c(h,i);for(var p=i.lifeTime,v=null===i.startTime?h*i.lifeTime/e:i.startTime,S=i.frameStart+f(i.frameStartRange),T=(new THREE.Vector3).addVectors((new THREE.Vector3).fromArray(i.position),(new THREE.Vector3).fromArray(d(i.positionRange))),y=(new THREE.Vector3).addVectors((new THREE.Vector3).fromArray(i.velocity),(new THREE.Vector3).fromArray(d(i.velocityRange))),_=(new THREE.Vector3).addVectors((new THREE.Vector3).fromArray(i.acceleration),(new THREE.Vector3).fromArray(d(i.accelerationRange))),w=(new THREE.Vector4).addVectors((new THREE.Vector4).fromArray(i.colorMult),(new THREE.Vector4).fromArray(d(i.colorMultRange))),x=i.spinStart+f(i.spinStartRange),E=i.spinSpeed+f(i.spinSpeedRange),R=i.startSize+f(i.startSizeRange),b=i.endSize+f(i.endSizeRange),z=(new THREE.Vector4).fromArray(i.orientation),g=0;g<1;++g){var P=s*g+h*s*4+t*s*4,A=P+1,I=P+2,B=P+3;u[0+P]=T.x,u[0+A]=T.y,u[0+I]=T.z,u[0+B]=v,u[4+P]=r[g][0],u[4+A]=r[g][1],u[4+I]=p,u[4+B]=S,u[8+P]=y.x,u[8+A]=y.y,u[8+I]=y.z,u[8+B]=R,u[a+P]=_.x,u[a+A]=_.y,u[a+I]=_.z,u[a+B]=b,u[n+P]=x,u[n+A]=E,u[n+I]=0,u[n+B]=0,u[o+P]=z.x,u[o+A]=z.y,u[o+I]=z.z,u[o+B]=z.w,u[l+P]=w.x,u[l+A]=w.y,u[l+I]=w.z,u[l+B]=w.w}}this.interleavedBuffer.needsUpdate=!0,this.material.uniforms.worldVelocity.value=new THREE.Vector3(i.worldVelocity[0],i.worldVelocity[1],i.worldVelocity[2]),this.material.uniforms.worldAcceleration.value=new THREE.Vector3(i.worldAcceleration[0],i.worldAcceleration[1],i.worldAcceleration[2]),this.material.uniforms.timeRange.value=i.timeRange,this.material.uniforms.frameDuration.value=i.frameDuration,this.material.uniforms.numFrames.value=i.numFrames,this.material.uniforms.rampSampler.value=this.rampTexture_,this.material.uniforms.colorSampler.value=this.colorTexture_,this.material.blending=this.blendFunc_}allocateParticles_(t,e){if(this.numParticles_!=t){if(6*t>65536&&THREE.BufferGeometry.MaxIndex<65536)throw"can't have more than 10922 particles per emitter";var r=new THREE.InterleavedBuffer(new Float32Array([0,0,0,0,-.5,-.5,0,0,0,0,0,0,.5,-.5,0,0,0,0,0,0,.5,.5,0,0,0,0,0,0,-.5,.5,0,0]),8),i=new THREE.InterleavedBufferAttribute(r,3,0);this.particleBuffer_.addAttribute("position",i);var u=new THREE.InterleavedBufferAttribute(r,2,4);this.particleBuffer_.addAttribute("uv",u);var m=new Uint16Array([0,1,2,0,2,3]);this.particleBuffer_.setIndex(new THREE.BufferAttribute(m,1)),this.numParticles_=t,this.interleavedBuffer=new THREE.InstancedInterleavedBuffer(new Float32Array(t*c.byteLength),s,1).setDynamic(!0),this.particleBuffer_.addAttribute("position",new THREE.InterleavedBufferAttribute(this.interleavedBuffer,3,0)),this.particleBuffer_.addAttribute("startTime",new THREE.InterleavedBufferAttribute(this.interleavedBuffer,1,3)),this.particleBuffer_.addAttribute("uvLifeTimeFrameStart",new THREE.InterleavedBufferAttribute(this.interleavedBuffer,4,4)),this.particleBuffer_.addAttribute("velocityStartSize",new THREE.InterleavedBufferAttribute(this.interleavedBuffer,4,8)),this.particleBuffer_.addAttribute("accelerationEndSize",new THREE.InterleavedBufferAttribute(this.interleavedBuffer,4,a)),this.particleBuffer_.addAttribute("spinStartSpinSpeed",new THREE.InterleavedBufferAttribute(this.interleavedBuffer,4,n)),this.particleBuffer_.addAttribute("orientation",new THREE.InterleavedBufferAttribute(this.interleavedBuffer,4,o)),this.particleBuffer_.addAttribute("colorMult",new THREE.InterleavedBufferAttribute(this.interleavedBuffer,4,l)),this.particleBuffer_.boundingSphere=new THREE.Sphere;var f={viewInverse:{type:"m4",value:this.particleSystem.camera.matrixWorld},worldVelocity:{type:"v3",value:null},worldAcceleration:{type:"v3",value:null},timeRange:{type:"f",value:null},time:{type:"f",value:null},timeOffset:{type:"f",value:null},frameDuration:{type:"f",value:null},numFrames:{type:"f",value:null},rampSampler:{type:"t",value:this.rampTexture_},colorSampler:{type:"t",value:this.colorTexture_}},d=new THREE.ShaderMaterial({uniforms:f,vertexShader:e.billboard?"\nuniform mat4 viewInverse;\nuniform vec3 worldVelocity;\nuniform vec3 worldAcceleration;\nuniform float timeRange;\nuniform float time;\nuniform float timeOffset;\nuniform float frameDuration;\nuniform float numFrames;\nattribute vec4 uvLifeTimeFrameStart;\nattribute float startTime;\nattribute vec4 velocityStartSize;\nattribute vec4 accelerationEndSize;\nattribute vec4 spinStartSpinSpeed;\nattribute vec4 colorMult;\nvarying vec2 outputTexcoord;\nvarying float outputPercentLife;\nvarying vec4 outputColorMult;\nvoid main() {\n\t\tfloat lifeTime = uvLifeTimeFrameStart.z;\n\t\tfloat frameStart = uvLifeTimeFrameStart.w;\n\t\tvec3 velocity = (modelMatrix * vec4(velocityStartSize.xyz,\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t 0.)).xyz + worldVelocity;\n\t\tfloat startSize = velocityStartSize.w;\n\t\tvec3 acceleration = (modelMatrix * vec4(accelerationEndSize.xyz,\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t 0)).xyz + worldAcceleration;\n\t\tfloat endSize = accelerationEndSize.w;\n\t\tfloat spinStart = spinStartSpinSpeed.x;\n\t\tfloat spinSpeed = spinStartSpinSpeed.y;\n\t\tfloat localTime = mod((time - timeOffset - startTime), timeRange);\n\t\tfloat percentLife = localTime / lifeTime;\n\t\tfloat frame = mod(floor(localTime / frameDuration + frameStart),\n\t\t\t\t\t\t\t\t\t\t numFrames);\n\t\tfloat uOffset = frame / numFrames;\n\t\tfloat u = uOffset + (uv.x + 0.5) * (1. / numFrames);\n\t\toutputTexcoord = vec2(u, uv.y + 0.5);\n\t\toutputColorMult = colorMult;\n\t\tvec3 basisX = viewInverse[0].xyz;\n\t\tvec3 basisZ = viewInverse[1].xyz;\n\t\tvec4 vertexWorld = modelMatrix * vec4(position, 1.0);\n\t\tfloat size = mix(startSize, endSize, percentLife);\n\t\tsize = (percentLife < 0. || percentLife > 1.) ? 0. : size;\n\t\tfloat s = sin(spinStart + spinSpeed * localTime);\n\t\tfloat c = cos(spinStart + spinSpeed * localTime);\n\t\tvec2 rotatedPoint = vec2(uv.x * c + uv.y * s, -uv.x * s + uv.y * c);\n\t\tvec3 localPosition = vec3(basisX * rotatedPoint.x + basisZ * rotatedPoint.y) * size +\n\t\t\t\t\t\t\t\t\t\t\t\tvelocity * localTime +\n\t\t\t\t\t\t\t\t\t\t\t\tacceleration * localTime * localTime +\n\t\t\t\t\t\t\t\t\t\t\t\tvertexWorld.xyz;\n\t\toutputPercentLife = percentLife;\n\t\tgl_Position = projectionMatrix * viewMatrix * vec4(localPosition, 1.);\n}":"\nuniform mat4 worldViewProjection;\nuniform mat4 world;\nuniform vec3 worldVelocity;\nuniform vec3 worldAcceleration;\nuniform float timeRange;\nuniform float time;\nuniform float timeOffset;\nuniform float frameDuration;\nuniform float numFrames;\nattribute vec3 offset;\nattribute vec4 uvLifeTimeFrameStart;attribute float startTime;attribute vec4 velocityStartSize;attribute vec4 accelerationEndSize;attribute vec4 spinStartSpinSpeed;attribute vec4 orientation;attribute vec4 colorMult;\nvarying vec2 outputTexcoord;\nvarying float outputPercentLife;\nvarying vec4 outputColorMult;\nvoid main() {\nfloat lifeTime = uvLifeTimeFrameStart.z;\nfloat frameStart = uvLifeTimeFrameStart.w;\nvec3 velocity = (world * vec4(velocityStartSize.xyz,\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t0.)).xyz + worldVelocity;\nfloat startSize = velocityStartSize.w;\nvec3 acceleration = (world * vec4(accelerationEndSize.xyz,\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t0)).xyz + worldAcceleration;\nfloat endSize = accelerationEndSize.w;\nfloat spinStart = spinStartSpinSpeed.x;\nfloat spinSpeed = spinStartSpinSpeed.y;\nfloat localTime = mod((time - timeOffset - startTime), timeRange);\nfloat percentLife = localTime / lifeTime;\nfloat frame = mod(floor(localTime / frameDuration + frameStart),\n\t\t\t\t\t\t\t\t\tnumFrames);\nfloat uOffset = frame / numFrames;\nfloat u = uOffset + (uv.x + 0.5) * (1. / numFrames);\noutputTexcoord = vec2(u, uv.y + 0.5);\noutputColorMult = colorMult;\nfloat size = mix(startSize, endSize, percentLife);\nsize = (percentLife < 0. || percentLife > 1.) ? 0. : size;\nfloat s = sin(spinStart + spinSpeed * localTime);\nfloat c = cos(spinStart + spinSpeed * localTime);\nvec4 rotatedPoint = vec4((uv.x * c + uv.y * s) * size, 0.,\n\t\t\t\t\t\t\t\t\t\t\t\t (uv.x * s - uv.y * c) * size, 1.);\nvec3 center = velocity * localTime +\n\t\t\t\t\t\t\tacceleration * localTime * localTime +\n\t\t\t\t\t\t\tposition +offset;\nvec4 q2 = orientation + orientation;\nvec4 qx = orientation.xxxw * q2.xyzx;\nvec4 qy = orientation.xyyw * q2.xyzy;\nvec4 qz = orientation.xxzw * q2.xxzz;\nmat4 localMatrix = mat4(\n\t\t(1.0 - qy.y) - qz.z,\n\t\tqx.y + qz.w,\n\t\tqx.z - qy.w,\n\t\t0,\n\t\tqx.y - qz.w,\n\t\t(1.0 - qx.x) - qz.z,\n\t\tqy.z + qx.w,\n\t\t0,\n\t\tqx.z + qy.w,\n\t\tqy.z - qx.w,\n\t\t(1.0 - qx.x) - qy.y,\n\t\t0,\n\t\tcenter.x, center.y, center.z, 1);\nrotatedPoint = localMatrix * rotatedPoint;\noutputPercentLife = percentLife;\ngl_Position = projectionMatrix * modelViewMatrix * rotatedPoint;\n}",fragmentShader:"\n#ifdef GL_ES\nprecision mediump float;\n#endif\nuniform sampler2D rampSampler;\nuniform sampler2D colorSampler;\nvarying vec2 outputTexcoord;\nvarying float outputPercentLife;\nvarying vec4 outputColorMult;\nvoid main() {\n\t\tvec4 colorMult = texture2D(rampSampler, vec2(outputPercentLife, 0.5)) * outputColorMult;\n\t\tgl_FragColor = texture2D(colorSampler, outputTexcoord) * colorMult;\n}",side:this.billboard_?THREE.DoubleSide:THREE.FrontSide,blending:this.blendFunc_,depthTest:!0,depthWrite:!1,transparent:!0});this.geometry=this.particleBuffer_,this.material=d}}setParameters(t,e){this.validateParameters(t);var r=t.numParticles;this.allocateParticles_(r,t),this.createParticles_(0,r,t,e)}draw(t,e,r){var i=this.material.uniforms;i.time.value=this.timeSource_(),i.timeOffset.value=r}createOneShot(){return new m(this,this.particleSystem.scene)}clone(t){return void 0===t&&(t=this.particleSystem.createParticleEmitter(this.colorTexture_,this.timeSource_)),t.geometry=this.geometry,t.material=this.material.clone(),t.material.uniforms.viewInverse.value=this.particleSystem.camera.matrixWorld,t.material.uniforms.rampSampler.value=this.rampTexture_,t.material.uniforms.colorSampler.value=this.colorTexture_,super.copy(t),t}}class d extends f{constructor(t,e,r,i,a,n){super(t,i,n),this.allocateParticles_(e,r),this.validateParameters(r),this.parameters=r,this.perParticleParamSetter=a,this.birthIndex_=0,this.maxParticles_=e}birthParticles(t){var e=this.parameters.numParticles;for(this.parameters.startTime=this.timeSource_(),this.parameters.position=t;this.birthIndex_+e>=this.maxParticles_;){var r=this.maxParticles_-this.birthIndex_;this.createParticles_(this.birthIndex_,r,this.parameters,this.perParticleParamSetter),e-=r,this.birthIndex_=0}this.createParticles_(this.birthIndex_,e,this.parameters,this.perParticleParamSetter),0===this.birthIndex_&&this.particleSystem.scene.add(this),this.birthIndex_+=e}}t.ACCELERATION_END_SIZE_IDX=a,t.COLOR_MULT_IDX=l,t.CORNERS_=r,t.LAST_IDX=s,t.ORIENTATION_IDX=o,t.OneShot=m,t.POSITION_START_TIME_IDX=0,t.ParticleEmitter=f,t.ParticleSpec=u,t.ParticleSystem=class{constructor(t,e,r,a){this.scene=t,this.camera=e,this.drawables_=[];for(var n=[0,.2,.7,1,.7,.2,0,0],o=[],l=0;l<8;++l)for(var s=0;s<8;++s){var c=n[s]*n[l];o.push(c,c,c,c)}var u=this.createTextureFromFloats(8,8,o),m=this.createTextureFromFloats(2,1,[1,1,1,1,1,1,1,0]);this.now_=new Date,this.timeBase_=new Date,this.timeSource_=r||i(this),this.randomFunction_=a||function(){return Math.random()},this.defaultColorTexture=u,this.defaultRampTexture=m}createTextureFromFloats(t,e,r,i){var a=null;if(null==i){for(var n,o=new Uint8Array(r.length),l=0;l<r.length;l++)n=255*r[l],o[l]=n;return(a=new THREE.DataTexture(o,t,e,THREE.RGBAFormat)).minFilter=THREE.LinearFilter,a.magFilter=THREE.LinearFilter,a.needsUpdate=!0,a}return a=i}createParticleEmitter(t,e){var r=new f(this,t,e);return this.drawables_.push(r),r}createTrail(t,e,r,i,a){var n=new d(this,t,e,r,i,a);return this.drawables_.push(n),n}draw(t,e,r){this.now_=new Date;for(var i=0;i<this.drawables_.length;++i)this.drawables_[i].draw(e,t,0)}},t.SPIN_START_SPIN_SPEED_IDX=n,t.Trail=d,t.UV_LIFE_TIME_FRAME_START_IDX=4,t.VELOCITY_START_SIZE_IDX=8,t.createDefaultClock_=i,t.singleParticleArray_=c,Object.defineProperty(t,"__esModule",{value:!0})}));
